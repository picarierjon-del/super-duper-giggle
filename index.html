<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Libro Presenze ‚Äì Mobile</title>
<style>
  :root { --fs: 16px; --pad: 8px; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    background: #f6f6f6;
  }
  header {
    background:#1a73e8; color:white; padding:10px 15px;
    display:flex; justify-content:space-between; align-items:center;
    flex-wrap:wrap;
  }
  header h1 { margin:0; font-size:18px; }
  main { padding:15px; }
  button {
    font-size: var(--fs);
    padding: 6px 12px;
    border:none;
    border-radius:6px;
  }
  button.primary { background:#1a73e8; color:white; }
  button.secondary { background:#eee; color:#333; }

  /* Lista movimenti */
  .toolbar {
    display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px;
    align-items:center;
  }
  .toolbar input {
    flex:1; padding:6px 8px; font-size:15px;
    border:1px solid #ccc; border-radius:6px;
  }
  .dip-list { list-style:none; margin:0; padding:0; }
  .dip-item {
    background:white;
    margin-bottom:10px;
    padding:12px;
    border-radius:8px;
    box-shadow:0 1px 2px rgba(0,0,0,0.1);
  }
  .dip-top {
    display:flex; justify-content:space-between; align-items:center;
  }
  .dip-name { font-weight:600; font-size:16px; }
  .dip-actions { display:flex; gap:6px; }
  .dip-tot { color:#555; font-size:14px; margin-top:4px; }

  /* Scheda ore */
  .giorno-row {
    background:white;
    margin-bottom:8px;
    padding:10px;
    border-radius:6px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .giorno-row input {
    width:70px;
    font-size:16px;
    padding:6px;
  }

  .hidden { display:none; }
</style>
</head>
<body>

<!-- ======= Vista MOVIMENTI ======= -->
<div id="view-movimenti">
  <header>
    <h1>Movimenti</h1>
    <div>
      <button class="secondary" id="btn-mese">Mese/Anno</button>
      <button class="primary" id="btn-add">+ Dipendente</button>
    </div>
  </header>
  <main>
    <div class="toolbar">
      <input type="text" id="search" placeholder="Filtra per nome‚Ä¶">
    </div>
    <ul id="lista-dip" class="dip-list"></ul>
  </main>
</div>

<!-- ======= Vista SCHEDA ORE ======= -->
<div id="view-scheda" class="hidden">
  <header>
    <button class="secondary" id="btn-back">‚¨ÖÔ∏é</button>
    <h1 id="scheda-title">Scheda Ore</h1>
    <button class="primary" id="btn-save">üíæ Salva</button>
  </header>
  <main>
    <div style="margin-bottom:12px;">
      <label>Nome:<br>
        <input type="text" id="scheda-nome" style="width:100%; font-size:16px;">
      </label>
    </div>
    <div style="margin-bottom:12px;">
      <label>Paga oraria (‚Ç¨):<br>
        <input type="number" step="0.01" min="0" id="scheda-paga" style="width:100%; font-size:16px;">
      </label>
    </div>
    <div id="giorni-list"></div>
  </main>
</div>

<script>
/* === Variabili principali === */
const mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth()+1;
let data = loadData();

/* === Elementi DOM === */
const viewMov   = document.getElementById('view-movimenti');
const viewSched = document.getElementById('view-scheda');
const listaDip  = document.getElementById('lista-dip');
const giorniList= document.getElementById('giorni-list');
const schedaTitle=document.getElementById('scheda-title');
const inpNome   = document.getElementById('scheda-nome');
const inpPaga   = document.getElementById('scheda-paga');
const searchBox = document.getElementById('search');

let editingIndex = null;

/* === Funzioni utili === */
function keyLS() {
  return `presenze:${currentYear}-${String(currentMonth).padStart(2,'0')}`;
}
function daysInMonth(m,y) {
  return new Date(y,m,0).getDate();
}
function loadData() {
  const raw = localStorage.getItem(keyLS());
  return raw ? JSON.parse(raw) : {dip:[]};
}
function saveData() {
  localStorage.setItem(keyLS(), JSON.stringify(data));
}

/* === Vista Movimenti === */
function renderMovimenti() {
  const filtro = searchBox.value.toLowerCase();
  listaDip.innerHTML = '';
  data.dip.forEach((d,idx) => {
    if (filtro && !d.nome.toLowerCase().includes(filtro)) return;
    const totOre = d.ore.reduce((s,v)=> s + (parseFloat(v)||0), 0);
    const totPay = (parseFloat(d.paga)||0) * totOre;
    const li = document.createElement('li');
    li.className = 'dip-item';
    li.innerHTML = `
      <div class="dip-top">
        <div class="dip-name">${d.nome || '‚Äî'}</div>
        <div class="dip-actions">
          <button class="secondary btn-edit">‚úèÔ∏è</button>
          <button class="secondary btn-del">üóëÔ∏è</button>
        </div>
      </div>
      <div class="dip-tot">${totOre.toFixed(2)} ore ‚Äì ‚Ç¨${totPay.toFixed(2)}</div>
    `;
    li.querySelector('.btn-edit').onclick = () => openScheda(idx);
    li.querySelector('.btn-del').onclick = () => deleteDipendente(idx);
    listaDip.appendChild(li);
  });
}

/* === Elimina dipendente === */
function deleteDipendente(index) {
  if (confirm('Eliminare questo dipendente?')) {
    data.dip.splice(index,1);
    saveData();
    renderMovimenti();
  }
}

/* === Apertura scheda === */
function openScheda(index) {
  editingIndex = index;
  const d = data.dip[index];
  inpNome.value = d.nome;
  inpPaga.value = d.paga;
  schedaTitle.textContent = `Scheda Ore ‚Äì ${mesi[currentMonth-1]} ${currentYear}`;
  renderGiorni(d.ore);
  viewMov.classList.add('hidden');
  viewSched.classList.remove('hidden');
}

function renderGiorni(ore) {
  giorniList.innerHTML = '';
  const n = daysInMonth(currentMonth, currentYear);
  for(let g=1; g<=n; g++){
    const row = document.createElement('div');
    row.className='giorno-row';
    row.innerHTML = `
      <div>${String(g).padStart(2,'0')}</div>
      <input type="number" step="0.25" min="0" value="${ore[g-1] ?? ''}">
    `;
    giorniList.appendChild(row);
  }
}

/* === Salvataggio scheda === */
document.getElementById('btn-save').onclick = () => {
  const d = data.dip[editingIndex];
  d.nome = inpNome.value;
  d.paga = parseFloat(inpPaga.value) || 0;
  const inputs = giorniList.querySelectorAll('input');
  d.ore = [...inputs].map(inp => inp.value === '' ? null : parseFloat(inp.value));
  saveData();
  backToMovimenti();
};

/* === Torna a Movimenti === */
function backToMovimenti() {
  viewSched.classList.add('hidden');
  viewMov.classList.remove('hidden');
  renderMovimenti();
}
document.getElementById('btn-back').onclick = backToMovimenti;

/* === Aggiungi Dipendente === */
document.getElementById('btn-add').onclick = () => {
  const n = daysInMonth(currentMonth, currentYear);
  data.dip.push({nome:'', paga:0, ore:Array(n).fill(null)});
  saveData();
  renderMovimenti();
};

/* === Selezione Mese/Anno === */
document.getElementById('btn-mese').onclick = () => {
  const newM = prompt('Inserisci mese (1-12):', currentMonth);
  const newY = prompt('Inserisci anno:', currentYear);
  if(newM && newY){
    currentMonth = Math.min(Math.max(parseInt(newM),1),12);
    currentYear  = parseInt(newY);
    data = loadData();
    renderMovimenti();
  }
};

/* === Filtro live === */
searchBox.addEventListener('input', renderMovimenti);

/* === Avvio === */
renderMovimenti();
</script>
</body>
</html>
